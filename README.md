# Azure VM Configuration Comparison Script

## Overview
The `vm-diff.ps1` PowerShell script compares Azure Virtual Machine (VM) configuration JSON files stored in two folders, typically representing pre- and post-upgrade states (e.g., before and after an image upgrade). It identifies files with matching prefixes (e.g., `vm1` in `vm1-config-20250918-162030.json`), verifies that the same set of VM prefixes exists in both folders, reports missing files, and outputs line-by-line differences for files with changes. If all compared files are identical, it outputs a single message: "All files are showing no differences." The script is designed for auditing VM configuration changes in Azure environments.

## Purpose
The script:
- Compares JSON configuration files with matching VM prefixes across two folders (e.g., `reports-20250918-162030` and `reports-20250919-081000`).
- Verifies that the number of files (based on VM prefixes) matches between folders and reports any missing files with their respective folder.
- Outputs differences in VM configurations as differing lines (e.g., changed JSON properties like VM size) with line numbers, only for files with differences.
- Confirms if all files are identical with a single message, reducing console clutter.
- Supports workflows for validating VM upgrades by integrating with scripts like `vm-config-timestamp-folder.ps1`.

## Features
- **Prefix-Based Matching**: Identifies files with the same VM prefix (before the first `-` in filenames like `vm1-config-20250918-162030.json`).
- **Prefix Count Verification**: Checks if the same VM prefixes exist in both folders and reports missing files.
- **Line-by-Line Comparison**: Compares JSON files as text, showing exact line differences (e.g., changed properties) with line numbers.
- **Selective Output**: Only displays differences for files with changes; outputs "All files are showing no differences" if all files match.
- **Error Handling**: Validates folder paths, skips invalid or missing files, and handles JSON file access errors.

## Prerequisites
- **PowerShell**: Version 5.1 or later (PowerShell 7.x recommended for cross-platform use).
- **Input Files**: JSON configuration files generated by a script like `vm-config-timestamp-folder.ps1`, stored in timestamped folders (e.g., `reports-20250918-162030`).
  - Expected filename format: `<vmName>-<suffix>.json` (e.g., `vm1-config-20250918-162030.json`).
  - Files should contain valid JSON from the `Get-AzVM` cmdlet.
- **No Azure Modules Required**: The script only parses JSON files, so no Azure authentication or modules (`Az.Accounts`, `Az.Compute`, `Az.ResourceGraph`) are needed.

## Usage
1. **Save the Script**:
   - Save the script as `vm-diff.ps1` in your working directory.

2. **Run the Script**:
   - Execute with the paths to the pre- and post-upgrade folders:
     ```powershell
     .\vm-diff.ps1 -PreFolder "reports-20250918-162030" -PostFolder "reports-20250919-081000"
     ```
   - **Workflow**:
     - Use with `vm-config-timestamp-folder.ps1` to generate configuration files before and after VM upgrades.
     - Run this script to compare outputs and identify changes or confirm consistency.

3. **Output**:
   - **Missing Files**: Lists any VM prefixes missing in one folder, with the filename and folder name.
   - **Differences**: For each file pair with differences, shows line-by-line changes with line numbers, "Before" content, and "After" content.
   - **No Differences**: If all matching file pairs are identical, outputs: `All files are showing no differences.`
   - **Example Output**:
     - **With Differences**:
       ```
       Prefix count matches between folders: 2 prefixes found.
       Differences found in the following files:
       Comparing vm1-config-20250918-162030.json with vm1-config-20250919-081000.json for prefix: vm1
       LineNumber Before                                    After
       ---------- ------                                    -----
       5          "VmSize": "Standard_D2s_v3",              "VmSize": "Standard_D4s_v3",
       Comparison complete.
       ```
     - **No Differences**:
       ```
       Prefix count matches between folders: 2 prefixes found.
       All files are showing no differences.
       Comparison complete.
       ```
     - **Missing Files**:
       ```
       Prefix count mismatch detected:
       Files missing in PreFolder (reports-20250918-162030):
       Prefix  File                           MissingIn
       ------  ----                           ---------
       vm3     vm3-config-20250919-081000.json reports-20250918-162030
       All files are showing no differences.
       Comparison complete.
       ```

## Input File Format
- **Folders**: Two folders containing JSON files (e.g., `reports-20250918-162030` and `reports-20250919-081000`).
- **Filenames**: Must follow the format `<vmName>-<suffix>.json`, where `vmName` is the prefix before the first `-` (e.g., `vm1-config-20250918-162030.json`).
- **Content**: JSON files should contain VM configurations from `Get-AzVM`, typically generated by `vm-config-timestamp-folder.ps1`.

## Installation
1. **Save the Script**:
   - Copy the script content to a file named `vm-diff.ps1`.

2. **Verify PowerShell**:
   - Ensure PowerShell 5.1 or later is installed:
     ```powershell
     $PSVersionTable.PSVersion
     ```
   - For cross-platform use, install PowerShell 7.x from [GitHub](https://github.com/PowerShell/PowerShell/releases).

## Error Handling
- **Missing Folders**: Exits with an error if `PreFolder` or `PostFolder` doesnâ€™t exist.
- **No Matching Prefixes**: Warns if no VM prefixes match between folders.
- **Missing Files**: Reports prefixes present in one folder but not the other, with filenames and folder details.
- **File Access Errors**: Fails if files are not accessible or not valid JSON; ensure files are outputs from `Get-AzVM`.
- **Ambiguous Files**: Assumes one file per VM prefix per folder; takes the first match if multiple exist.

## Troubleshooting
- **No Differences Reported**:
  - Verify files differ using:
    ```powershell
    Compare-Object (Get-Content "reports-20250918-162030/vm1-config-20250918-162030.json") (Get-Content "reports-20250919-081000/vm1-config-20250919-081000.json")
    ```
  - Ensure JSON files are valid:
    ```powershell
    Get-Content -Path "reports-20250918-162030/vm1-config-20250918-162030.json" -Raw | ConvertFrom-Json
    ```
- **Missing Files**:
  - Check filenames follow `<vmName>-<suffix>.json` using:
    ```powershell
    Get-ChildItem -Path "reports-20250918-162030" -Filter "*.json"
    ```
  - Ensure `vm-config-timestamp-folder.ps1` ran successfully for both folders.
- **JSON Formatting Issues**:
  - Inconsistent JSON formatting (e.g., indentation) may show as differences. Normalize JSON if needed:
    ```powershell
    Get-Content -Path "file.json" -Raw | ConvertFrom-Json | ConvertTo-Json -Depth 100 | Out-File "normalized.json"
    ```
- **Permission Issues**:
  - Ensure read access to folders. Run PowerShell as an administrator if needed.

## Customizations
- **Change Prefix Delimiter**:
  - If filenames use `_` instead of `-`, update:
    ```powershell
    $prePrefixes = $preFiles | ForEach-Object { ($_.Name -split '_')[0] } | Sort-Object -Unique
    ```
- **Output to File**:
  - Save differences to a CSV:
    ```powershell
    if ($hasDifferences) {
        $allDiffs | ForEach-Object {
            $_.Differences | Export-Csv -Path "diffs-$($_.Prefix)-$((Get-Date -Format 'yyyyMMdd-HHmmss')).csv" -NoTypeInformation
        }
    }
    ```
- **Ignore Whitespace**:
  - To ignore whitespace in line comparisons, trim lines in `Compare-FileLines`:
    ```powershell
    $preLine = if ($i -lt $preLines.Count) { $preLines[$i].Trim() } else { "<EOF>" }
    $postLine = if ($i -lt $postLines.Count) { $postLines[$i].Trim() } else { "<EOF>" }
    ```
- **Multiple Files per Prefix**:
  - If multiple files exist per VM, select the latest:
    ```powershell
    $preFile = $preFiles | Where-Object { $_.Name -like "$prefix-*.json" } | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    ```

## Related Scripts
- **Configuration Capture**: Use with `vm-config-timestamp-folder.ps1` to generate JSON files in timestamped folders:
  ```powershell
  .\vm-config-timestamp-folder.ps1 -JsonFilePath "input.json"
  ```
- **Output Structure**: Pairs with folders like `reports-20250918-162030` containing files like `vm1-config-20250918-162030.json`.

## Security Considerations
- **File Access**: Ensure folders are in a secure location, as VM configurations may contain sensitive data (e.g., network details).
- **Permissions**: Run with appropriate read permissions for the folders. Avoid running in untrusted directories.